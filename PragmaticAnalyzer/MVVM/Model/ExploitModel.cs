using HtmlAgilityPack;
using PragmaticAnalyzer.Configs;
using PragmaticAnalyzer.Databases;
using System.Collections.ObjectModel;
using System.IO;
using System.Net.Http;

namespace PragmaticAnalyzer.MVVM.Model
{
    public class ExploitModel
    {
        private readonly HttpClient _httpClient;
        public event Action<string>? NotifyRequested;
        private readonly ExploitConfig _config;

        public ExploitModel(ExploitConfig exploitConfig)
        {
            _config = exploitConfig;
            var handler = new HttpClientHandler
            {
                ClientCertificateOptions = ClientCertificateOption.Manual,
                ServerCertificateCustomValidationCallback =
            (httpRequestMessage, cert, cetChain, policyErrors) => { return true; }
            };
            _httpClient = new HttpClient(handler)
            {
                Timeout = TimeSpan.FromSeconds(30),
            };
            _httpClient.DefaultRequestHeaders.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 YaBrowser/25.6.0.0 Safari/537.36");
            _httpClient.DefaultRequestHeaders.Add("Accept", "image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8");
            _httpClient.DefaultRequestHeaders.Add("Accept-Language", "ru,en-US;q=0.9,en;q=0.8");
            _httpClient.DefaultRequestHeaders.Add("Accept-Encoding", "gzip, deflate, br");
              _httpClient.DefaultRequestHeaders.Add("Connection", "keep-alive");
        }

        public async Task<ObservableCollection<Exploit>> GetDatabase(CancellationToken ct)
        {
            NotifyRequested?.Invoke("Модуль парсинга запущен");

            int counter = _config.StartPoint;
            if (counter is not 0)
            {
                NotifyRequested?.Invoke($"Продолжение парсинга с {counter} записи");
            }

            ObservableCollection<Exploit> database = [];
            var rnd = new Random();
            HtmlWeb web = new();

            while (true)
            {
                if (ct.IsCancellationRequested)
                {
                    NotifyRequested?.Invoke("Модуль парсинга принудительно остановлен");
                    _config.StartPoint = counter;
                    break;
                }

                if (counter % 5 is 0)
                {
                    var stopValue = rnd.Next(5000, 10000);
                    NotifyRequested?.Invoke($"Приостановлено на {stopValue / 1000} сек.");
                    await Task.Delay(stopValue);
                }

                var exploitVdbUrl = _config.ExploitUrlVdb + $"exploits/{counter}";
                var exploitVulnersUrl = _config.ExploitUrlVulners + counter;

                NotifyRequested?.Invoke($"Обращение к {exploitVdbUrl}");
                var exploitVdbResponse = await _httpClient.GetAsync(exploitVdbUrl);

                NotifyRequested?.Invoke($"Обращение к {exploitVulnersUrl}");
                var exploitVulnersResponse = await _httpClient.GetAsync(exploitVulnersUrl);

                if ((int)exploitVdbResponse.StatusCode is 404) //|| (int)exploitVulnersResponse.StatusCode is 404)
                {
                    NotifyRequested?.Invoke($"Запись {counter} не существует или произошла оишбка");
                    counter++;
                    continue;
                }
                exploitVdbResponse.EnsureSuccessStatusCode();
                //exploitVulnersResponse.EnsureSuccessStatusCode(); //

                var htmlVbd = await exploitVdbResponse.Content.ReadAsStringAsync();
              //  var htmlVulners = await exploitVulnersResponse.Content.ReadAsStringAsync(); //

                HtmlDocument docVbd = new();
                HtmlDocument docVulners = new();
                docVbd.LoadHtml(htmlVbd);
               // docVulners.LoadHtml(htmlVulners); //

                var name = docVbd.DocumentNode.SelectSingleNode("//h1[contains(@class,'card-title')]")?.InnerText.Trim();
                if (name is "404")
                {
                    NotifyRequested?.Invoke("Конец выполнения");
                    _config.StartPoint = counter;
                    break;
                }

                var downloadUrl = _config.ExploitUrlVdb + $"download/{counter}";
                NotifyRequested?.Invoke($"Обращение к {downloadUrl}");
                using HttpResponseMessage downloadResponse = await _httpClient.GetAsync(downloadUrl);

                var statusCode = (int)downloadResponse.StatusCode;
                if (statusCode is 429 or 403)
                {
                    NotifyRequested?.Invoke("Работа приостановлена на 5 минут");
                    await Task.Delay(300000);
                    continue;
                }

                using var stream = await downloadResponse.Content.ReadAsStreamAsync();
                using var fileStream = File.Create(Path.Combine(GlobalConfig.ExploitTextPath, $"{counter}.txt"));
                await stream.CopyToAsync(fileStream);

                var id = docVbd.DocumentNode.SelectSingleNode("(//h6[contains(@class,'stats-title')])[1]")?.InnerText.Trim();
                var cve = docVbd.DocumentNode.SelectSingleNode("//a[contains(@href, '/vuln/detail/CVE-')]")?.InnerText.Trim();
               // var description = docVulners.DocumentNode.SelectSingleNode("//*[contains(@class, 'Description-root')]//p")?.InnerText.Trim(); //
                var author = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[2]")?.InnerText.Trim();
                var type = docVbd.DocumentNode.SelectSingleNode("//a[contains(@href, 'type=')]")?.InnerText.Trim();
                var platform = docVbd.DocumentNode.SelectSingleNode("//a[starts-with(@href, '/?platform=')]")?.InnerText.Trim();
                var datePublication = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[1]")?.InnerText.Trim();

                var nCol6A = docVbd.DocumentNode.SelectSingleNode("(//div[contains(@class,'col-6 text-center')]/h6/a)[n]")?.InnerText.Trim(); //что это
                database.Add(new()
                {
                    Id = id,
                    Name = name,
                    Cve = cve,
                  //  Description = description, //
                    Author = author,
                    Type = type,
                    Platform = platform,
                    DatePublication = datePublication,
                });

                NotifyRequested?.Invoke($"Добавлена запись {counter}");

                counter++;
            }
            _config.StartPoint = counter;
            return database;
        }
    }
}