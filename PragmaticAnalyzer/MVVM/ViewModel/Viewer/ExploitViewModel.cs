using PragmaticAnalyzer.Abstractions;
using PragmaticAnalyzer.Configs;
using PragmaticAnalyzer.Core;
using PragmaticAnalyzer.Databases;
using PragmaticAnalyzer.DTO;
using PragmaticAnalyzer.MVVM.Model;
using PragmaticAnalyzer.Services;
using System.Collections.ObjectModel;
using System.IO;
using System.Net.Http;


namespace PragmaticAnalyzer.MVVM.ViewModel.Viewer
{
    public class ExploitViewModel : ViewModelBase
    {
        private ExploitModel _model;
        private readonly IFileService _fileService;
        private readonly Func<string, DataType, Task> UpdateConfig;
        private CancellationTokenSource? _updateCancellationTokenSource;
        private ExploitConfig _exploitConfig;
        public ObservableCollection<Exploit> Exploits { get; set; }
        public Exploit? SelectedExploit { get => Get<Exploit?>(); set => Set(value); }
        public string Status { get => Get<string>(); set => Set(value); }
        public bool IsIndeterminateProgressBar { get => Get<bool>(); set => Set(value); }

        public ExploitViewModel(ObservableCollection<Exploit> exploits, Func<string, DataType, Task> updateConfig, ExploitConfig exploitConfig)
        {
            Exploits = exploits;
            UpdateConfig = updateConfig;
            _exploitConfig = exploitConfig;
            IsIndeterminateProgressBar = false;
            _fileService = new FileService();
            _model = new(exploitConfig);
            _model.NotifyRequested += (msg) => Status += "\n" + msg;
        }

        public RelayCommand UpdateCommand => GetCommand(async o =>
        {
            await UpdateExploittDb();
        }, o => _updateCancellationTokenSource is null);

        public RelayCommand CancelUpdateCommand => GetCommand(o =>
        {
            _updateCancellationTokenSource?.Cancel();
        }, o => _updateCancellationTokenSource is not null);

        public RelayCommand OpenFileCommand => GetCommand(o =>
        {
            string fullPath = Path.Combine(GlobalConfig.ExploitTextPath, $"{o}.txt");
            if (File.Exists(fullPath))
            {
                System.Diagnostics.Process.Start("notepad.exe", fullPath);
            }
        });

        public async Task UpdateExploittDb()
        {
            IsIndeterminateProgressBar = true;
            _updateCancellationTokenSource = new();
            try
            {
                var newExploits = await _model.GetDatabase(_updateCancellationTokenSource.Token);
                if (newExploits is null) return;
                foreach (var exploit in newExploits)
                {
                    Exploits.Add(exploit);
                }
                await _fileService.SaveDTOAsync(Exploits, DataType.Exploit, GlobalConfig.ExploitPath);
                await _fileService.SaveDTOAsync(_exploitConfig, DataType.ExploitConfig, GlobalConfig.ExploitConfigPath);
                UpdateConfig?.Invoke(DateTime.Now.ToString("f"), DataType.Exploit);
            }
            catch (HttpRequestException httpEx)
            {
                Status += "\n" + httpEx.Message;
            }
            catch (OperationCanceledException ctEx)
            {
                Status += "\n" + ctEx.Message;
            }
            catch (Exception ex)
            {
                Status += "\n" + ex.Message;
            }
            finally
            {
                IsIndeterminateProgressBar = false;
                _updateCancellationTokenSource?.Dispose();
                _updateCancellationTokenSource = null;
            }
        }
    }
}